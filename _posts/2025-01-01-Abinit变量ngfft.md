---
layout: post
title: "Abinit变量ngfft"
date: 2025-01-01
category: ABINIT variables
---
在ABINIT软件中，`ngfft` 是一个用于定义快速傅里叶变换（FFT）网格大小的参数。它决定了在三个维度上FFT网格的点数，直接影响计算的精度和效率。

---

### `ngfft` 的详细说明

1. **参数类型**：
   - **变量类型**：整数（integer）
   - **维度**：3维数组（`(3)`）

2. **默认值**：
   - **默认值**：`[0, 0, 0]`
   - 如果未提供 `ngfft` 或其值为 `[0, 0, 0]`，ABINIT会根据 `acell`、`rprim` 和 `ecut` 自动选择最优的 `ngfft` 值。这是推荐的做法。

3. **作用**：
   - 定义FFT网格在三个维度上的点数。
   - 每个维度的点数必须是2、3、5的乘积，以与ABINIT中FFT的基数兼容。
   - 总FFT点数为：`ngfft(1) × ngfft(2) × ngfft(3) = %nfft`。

4. **优化与近似**：
   - 如果手动设置 `ngfft` 的值小于推荐值（例如通过设置 `boxcutmin` 小于2.0），代码会运行得更快，但方程会通过低通傅里叶滤波器进行近似。
   - 代码会输出一个参数 `boxcut`，表示FFT盒子边长与倒空间向量基球直径的最小比值：
     - 当 `boxcut < 2` 时，使用了傅里叶滤波器近似。
     - 当 `boxcut < 1.5` 时，近似可能过于粗糙，结果可能不准确，建议测试更大的 `ngfft` 值。
     - 当 `boxcut > 2` 时，可以减少 `ngfft` 而不损失精度。

5. **内部存储**：
   - `ngfft` 在内部是一个大小为18的数组，其中：
     - `ngfft(1:3)`：存储用户定义的或自动选择的FFT网格点数。
     - `ngfft(4:6)`：存储稍大（修改后）的值，以提高FFT效率。
     - `ngfft(7)`：存储 `fftalg`（FFT算法选择）。
     - `ngfft(8)`：存储 `fftcache`（FFT缓存设置）。
     - `ngfft(9)`：指示FFT并行化是否激活（0：未激活，1：激活）。
     - `ngfft(10)`：FFT组的处理器数量。
     - `ngfft(11)`：处理器在组中的索引。
     - `ngfft(12)`：`n2proc`，倒空间中每个处理器处理的x-z平面数量。
     - `ngfft(13)`：`n3proc`，实空间中每个处理器处理的x-y平面数量。
     - `ngfft(14)`：`mpi_comm_fft`，负责FFT并行化的MPI通信器句柄。
     - `ngfft(15:18)`：尚未使用。

6. **存储点数**：
   - 在实空间中，每个处理器存储的点数为：`n1 × n2 × n3proc`。
   - 在倒空间中，每个处理器存储的点数为：`n1 × n2proc × n3`。


### 示例

假设你希望手动设置FFT网格点数，可以在输入文件中添加以下行：

```plaintext
ngfft 24 24 24
```

这将设置FFT网格在每个维度上的点数为24。

---

### 问：ABINIT怎样根据 acell、rprim 和 ecut 计算并自动选择最优的 ngfft 值的？

---

当未提供 `ngfft` 或其值为 `[0, 0, 0]` 时，ABINIT会根据以下输入参数自动计算最优的 `ngfft` 值：

1. **`acell`**：晶胞的初始尺寸（以玻尔半径为单位）。
2. **`rprim`**：晶胞的基向量（定义晶胞的形状和方向）。
3. **`ecut`**：平面波截断能量（以哈特里为单位）。

ABINIT通过以下步骤自动选择最优的 `ngfft` 值：



### 1. **计算倒空间中的最大波矢**
   - 根据 `ecut` 和平面波的动能公式：

     $$
     \frac{\hbar^2 |\mathbf{G}|^2}{2m} \leq \text{ecut}
     $$

     其中 $\mathbf{G}$ 是倒格矢，$m$ 是电子质量。
   - 由此可以确定倒空间中最大波矢的长度 $\|\mathbf{G}\|_{\text{max}}$。



### 2. **确定实空间中的最小网格间距**
   - 根据 Nyquist 采样定理，实空间中的网格间距 $\Delta r$ 必须满足：
     $$
     \Delta r \leq \frac{\pi}{|\mathbf{G}|_{\text{max}}}
     $$
     以确保能够准确表示倒空间中的最高频率分量。



### 3. **计算每个维度上的网格点数**
   - 根据晶胞的尺寸（`acell` 和 `rprim`）和最小网格间距 $\Delta r$，计算每个维度上的网格点数：
     $$
     \text{ngfft}(i) = \frac{\text{acell}(i) \cdot \text{rprim}(i)}{\Delta r}
     $$
     其中 $i = 1, 2, 3$ 表示三个维度。
   - 为了满足FFT算法的要求，`ngfft(i)` 必须是2、3、5的乘积。因此，ABINIT会将计算值向上取整到最近的满足条件的整数。



### 4. **考虑 `boxcutmin` 参数**
   - `boxcutmin` 是一个用户可调参数，用于控制FFT网格的最小尺寸与倒空间基球直径的比值。
   - 默认情况下，`boxcutmin = 2.0`，这意味着FFT网格的尺寸至少是倒空间基球直径的两倍，以确保高精度。
   - 如果 `boxcutmin` 设置为较小的值（如1.5），ABINIT会选择更小的 `ngfft` 值，从而加快计算速度，但会引入傅里叶滤波器近似，可能降低精度。



### 5. **输出 `boxcut` 参数**
   - ABINIT会计算并输出 `boxcut` 参数，表示FFT网格尺寸与倒空间基球直径的实际比值：
     $$
     \text{boxcut} = \frac{\text{FFT网格尺寸}}{\text{倒空间基球直径}}
     $$
   - 如果 `boxcut < 2`，说明使用了傅里叶滤波器近似；如果 `boxcut < 1.5`，近似可能过于粗糙，建议测试更大的 `ngfft` 值。



### 6. **优化FFT效率**
   - ABINIT会进一步调整 `ngfft` 的值，以提高FFT计算的效率。例如，选择稍大的 `ngfft` 值，以便更好地利用缓存和并行计算资源。



### 总结

ABINIT自动选择 `ngfft` 的过程基于以下原则：
1. 确保FFT网格能够准确表示倒空间中的最高频率分量（由 `ecut` 决定）。
2. 满足FFT算法的基数要求（2、3、5的乘积）。
3. 考虑 `boxcutmin` 参数，在精度和速度之间进行权衡。
4. 优化FFT计算的效率。

这种自动选择机制是推荐的，因为它能够根据输入参数动态调整 `ngfft`，确保计算的精度和效率。如果需要手动设置 `ngfft`，建议先运行自动选择机制，参考其输出的 `boxcut` 值，再进行调整。